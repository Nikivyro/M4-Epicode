<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>D7 - BackOffice</title>
        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
      </head>
<body>
    <button class="btn btn-primary" onclick="addProduct()">aggiungi prodotto</button>
    <div class="container">
        <div class="row">
            <div class="col-8">
              <div id="productsResponse"></div>
            </div>
            <div class="col-4">
              <h2>Aggiungi un prodotto</h2>
                <form id="user-form" class="" novalidate>

                    <div class="mb-3">
                      <label for="name" class="form-label">Nome</label>
                      <input type="text" class="form-control" id="name" required>
                      <span class="text-danger" id="name-error"></span>
                    </div>
            
                    <div class="mb-3">
                      <label for="description" class="form-label">description</label>
                      <textarea rows="4" class="form-control" id="description" required></textarea>
                      <span class="text-danger" id="description-error"></span>
                    </div>
            
                    <div class="mb-3">
                      <label for="brand" class="form-label">brand</label>
                      <input type="text" class="form-control" id="brand" required>
                      <span class="text-danger" id="brand-error"></span>
                    </div>
            
                    <div class="mb-3">
                      <label for="imageUrl" class="form-label">imageUrl</label>
                      <input type="text" class="form-control" id="imageUrl" required>
                      <span class="text-danger" id="imageUrl-error"></span>
                    </div>
                    
                    <div class="mb-3">
                      <label for="price" class="form-label">price</label>
                      <input type="text" class="form-control" id="price" required>
                      <span class="text-danger" id="price-error"></span>
                    </div>
            
                    <button type="submit" class="btn btn-primary">Salva</button>
            
                  </form>
            </div>
        </div>
    </div>
</body>
<script>
const URL = 'https://striveschool-api.herokuapp.com/api/product/'

const form = document.getElementById('user-form');

const nameInput = document.getElementById('name');
const descriptionlInput = document.getElementById('description');
const brandInput = document.getElementById('brand');
const imageUrlInput = document.getElementById('imageUrl');
const priceInput = document.getElementById('price');

form.addEventListener('submit', async (event) => {

  event.preventDefault();

  const isFormValid = handelFormValidation();
  if (!isFormValid) return false;

  const product = {
    name: nameInput.value,
    description: descriptionlInput.value,
    brand: brandInput.value,
    imageUrl: imageUrlInput.value,
    price: priceInput.value
  }

  try {
    const response = await fetch(`${URL}`, {
      method: 'POST',
      body: JSON.stringify(product),
      headers: {
        'Content-type': 'application/json; charset=UTF-8',
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NGU0ODRmZGRmZmI4YjAwMTQ0MTNiYjEiLCJpYXQiOjE2OTI2OTc4NTQsImV4cCI6MTY5MzkwNzQ1NH0.G2_s4iExw1Z8ix0cWRpJBoNZ5SpbQmx5ekcQ6axKa2I"
      }
    })

    if (response.ok) {
      window.location.href = 'index.html'
    } else {
      alert('Si è verificato un errore durante la creazione dell\'utente.')
    }
  } catch (error) {
    console.log('Errore durante il salvataggio: ', error);
    alert('Si è verificato un errore durante il salvataggio.')
  }
})



function handelFormValidation() {
  
  const validation = validateForm()
  let isValid = true;

  if (!validation.isValid) {

    for (const field in validation.errors) {
      const errorElement = document.getElementById(`${field}-error`)
      errorElement.textContent = '';
      errorElement.textContent = validation.errors[field]
    }

    isValid = false
    
  }

  return isValid

}

function validateForm() {
  const errors = {}

  const name = document.getElementById('name').value
  const description = document.getElementById('description').value
  const brand = document.getElementById('brand').value
  const imageUrl = document.getElementById('imageUrl').value
  const price = document.getElementById('price').value

  if (!name) errors.name = "Il campo nome è obbligatorio."
  else errors.name = "";

  if (!description) errors.description = "Il campo email è obbligatorio."
  else errors.description = "";

  if (!brand) errors.brand = "Il campo username è obbligatorio."
  else errors.brand = "";

  if (!imageUrl) errors.imageUrl = "Il campo telefono è obbligatorio."
  else errors.imageUrl = "";

  if (!price) errors.price = "Il campo prezzo è obbligatorio."
  else errors.price = "";

  return {
    isValid: Object.values(errors).every(value => value === ''),
    errors
  }
  
}


const productsContainer = document.getElementById("productsResponse");

const getProducts = async () => {
    try {
      const response = await fetch(URL, {
        headers: {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NGU0ODRmZGRmZmI4YjAwMTQ0MTNiYjEiLCJpYXQiOjE2OTI2OTc4NTQsImV4cCI6MTY5MzkwNzQ1NH0.G2_s4iExw1Z8ix0cWRpJBoNZ5SpbQmx5ekcQ6axKa2I"
        }
      });
      const products = await response.json();
    // console.log(products);
    table = document.createElement("table");
    table.classList.add('table','table-striped','table-hover');
    table.innerHTML = `
      <thead>
        <tr>
          <th scope="col">Name</th>
          <th scope="col">Descrizione</th>
          <th scope="col">Brand</th>
          <th scope="col">Image</th>
          <th scope="col">Price</th>
          <th scope="col">Azioni</th>
        </tr>
      </thead>
      <tbody>
      </tbody>
    `;
    const tbody = table.querySelector("tbody");
    products.forEach((product) => {
      const row = document.createElement("tr");
      row.innerHTML = `
        <td> <a href="detail.html?q=${product._id}&back=index.html">${product.name}</a></td>
        <td>${product.description}</td>
        <td>${product.brand}</td>
        <td>${product.imageUrl}</td>
        <td>${product.price}</td>
        <td><button onclick=getDataProduct('${product._id}')>modifica</button><button onclick=deleteProduct('${product._id}')>elimina</button></td>
      `;
      tbody.appendChild(row);
    });
    productsContainer.appendChild(table);

    } catch (error) {
      errorMsg.innerHTML = "Inserire una selezione valida o riprovare compilando i campi richiesti.";
      productsContainer.appendChild(errorMsg);
  
      console.error("Errore durante la fetch o la ricerca:", error);
    }
}




const deleteProduct = async (id) => {
  try {
    await fetch(`${URL}${id}`, {
      headers: {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NGU0ODRmZGRmZmI4YjAwMTQ0MTNiYjEiLCJpYXQiOjE2OTI2OTc4NTQsImV4cCI6MTY5MzkwNzQ1NH0.G2_s4iExw1Z8ix0cWRpJBoNZ5SpbQmx5ekcQ6axKa2I"
      },
      method: "DELETE",
    });
    windows.location.href = "backoffice.html"

    if (!response.ok) {
      const message = 'Error with Status Code: ' + response.status;
      throw new Error(message);
    }

    } catch (error) {
      console.log('Error: ' + err);
    }
}




const getDataProduct = async (prodId) => {
  console.log(`${URL}${prodId}`)

  try {
    await fetch(`${URL}${prodId}`, {
      headers: {
        "Authorization": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJfaWQiOiI2NGU0ODRmZGRmZmI4YjAwMTQ0MTNiYjEiLCJpYXQiOjE2OTI2OTc4NTQsImV4cCI6MTY5MzkwNzQ1NH0.G2_s4iExw1Z8ix0cWRpJBoNZ5SpbQmx5ekcQ6axKa2I"
      }
    });
    const result = await response.json()
    console.log(result);

  } catch (error) {
    console.log('Error: ' + err);
  }
} 



getProducts()
</script>
</html>